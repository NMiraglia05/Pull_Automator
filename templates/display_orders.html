{% extends "template.html" %}
{% block title %}Pull Schedule{% endblock %}

{% block content %}
<div class="container">
  <h1>Pull Schedule</h1>

  <div class="controls">
    <button id="reloadBtn">Reload</button>
    <button id="copyBtn" class="secondary">Copy JSON</button>
    <div style="margin-left:auto" class="small">Each top-level entry expands into 5 category rows.</div>
  </div>

  <table id="ordersTable" aria-describedby="desc">
    <caption id="desc" style="display:none">Key | Category | Items</caption>
    <thead>
      <tr>
        <th class="key-col">Key</th>
        <th class="category-col">Category</th>
        <th class="items-col">Items</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Unable to Pull</h2>
  <table id="unableTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Count</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const pullSchedule = {{ pull_schedule|tojson }};
const notPulled = {{ not_pulled|tojson }};
const categories = ['mining','hunting','mercantile','black_market','cargo_ship'];

const tbody = document.querySelector('#ordersTable tbody');
const unableBody = document.querySelector('#unableTable tbody');

function renderOrders(){
  tbody.innerHTML = '';
  for (const entry of pullSchedule){
    const keys = Object.keys(entry);
    if (keys.length === 0) continue;
    const topKey = keys[0];
    const catObj = entry[topKey];
    for (const cat of categories){
      const items = Array.isArray(catObj[cat]) ? catObj[cat] : [];
      const itemsText = items.length ? items.join(', ') : 'â€”';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="key-col">${topKey}</td>
        <td class="category-col">${cat}</td>
        <td class="items-col">${itemsText}</td>
      `;
      tbody.appendChild(tr);
    }
  }
}

function renderUnable(){
  unableBody.innerHTML = '';
  for (const [item,count] of Object.entries(notPulled)){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item}</td><td>${count}</td>`;
    unableBody.appendChild(tr);
  }
}

document.getElementById('copyBtn').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(JSON.stringify(pullSchedule, null, 2));
    alert('JSON copied to clipboard');
  } catch (err){
    alert('Could not copy: ' + err);
  }
});

document.getElementById('reloadBtn').addEventListener('click', ()=>{
  renderOrders();
  renderUnable();
});

renderOrders();
renderUnable();
</script>
{% endblock %}
