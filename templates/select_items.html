<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crafted Items Menu</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:24px}
    h1{font-size:1.6rem;margin-bottom:12px}
    h2{font-size:1.3rem;margin-top:28px;margin-bottom:6px;text-align:left}
    table{width:100%;border-collapse:collapse;margin-top:8px;margin-bottom:28px}
    th,td{padding:8px 10px;border:1px solid #ddd;text-align:left;vertical-align:top}
    th{background:#f4f4f4}
    .materials{white-space:pre-wrap;font-family:inherit}
    .search{margin-bottom:12px;padding:8px;width:100%;max-width:360px}
    button{padding:4px 8px;border:1px solid #bbb;border-radius:6px;background:#f9f9f9;cursor:pointer;transition:background 0.2s}
    button:hover{background:#e9e9e9}
    #added-box{border:1px solid #ccc;border-radius:8px;padding:10px;background:#fafafa;min-height:50px;margin-bottom:18px}
    .added-item{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
    .remove-btn{margin-left:10px;background:#f8d7da;border-color:#f5c2c7}
    .remove-btn:hover{background:#f1b0b7}
    .actions{margin-top:12px}
    /* Footer styling */
    footer{
      background-color:aquamarine;
      color:white;
      padding:12px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-size:0.9rem;
      flex-wrap:wrap;
      margin-top:40px;
    }
    footer a{color:white;text-decoration:underline;}
  </style>
</head>
<body>
  <h1>Crafted Items Menu</h1>

  <h2>Added Crafts</h2>
  <div id="added-box">(none yet)</div>

  <input id="filter" class="search" placeholder="Filter by item or material (type and press Enter)" />

  <div id="tables"></div>

  <div class="actions">
    <button id="goToGathering">Proceed to Character Setup</button>
  </div>

<script>
const crafted_item_lookup={ /* your entire lookup object here */ };

const container=document.getElementById('tables');
const addedBox=document.getElementById('added-box');
const filterInput=document.getElementById('filter');
const addedItems=new Set();

function formatMaterials(matObj){
    return Object.entries(matObj).map(([name,qty])=>`${name}: ${qty}`).join('\n');
}

function renderTables(filterText=''){
    container.innerHTML='';
    const f=filterText.trim().toLowerCase();

    for(const [category,items] of Object.entries(crafted_item_lookup)){
        const section=document.createElement('section');
        const title=document.createElement('h2');
        title.textContent=category;
        section.appendChild(title);

        const table=document.createElement('table');
        const thead=document.createElement('thead');
        thead.innerHTML='<tr><th>Item</th><th>Materials (name: qty)</th><th>Action</th></tr>';
        const tbody=document.createElement('tbody');

        for(const [item,materials] of Object.entries(items)){
            const haystack=item.toLowerCase()+' '+Object.keys(materials).join(' ').toLowerCase();
            if(!f||haystack.includes(f)){
                const tr=document.createElement('tr');
                const tdItem=document.createElement('td');tdItem.textContent=item;
                const tdMats=document.createElement('td');tdMats.className='materials';tdMats.textContent=formatMaterials(materials);
                const tdAction=document.createElement('td');
                const btn=document.createElement('button');btn.textContent='Add';btn.onclick=()=>handleAdd(item);
                tdAction.appendChild(btn);
                tr.append(tdItem,tdMats,tdAction);
                tbody.appendChild(tr);
            }
        }

        if(tbody.children.length>0){
            table.append(thead,tbody);
            section.appendChild(table);
            container.appendChild(section);
        }
    }
}

function handleAdd(item){
    if(!addedItems.has(item)){
        addedItems.add(item);
        renderAdded();
    }
}

function handleRemove(item){
    addedItems.delete(item);
    renderAdded();
}

function renderAdded(){
    if(addedItems.size===0){
        addedBox.innerHTML='(none yet)';
        return;
    }
    addedBox.innerHTML='';
    for(const item of addedItems){
        const div=document.createElement('div');
        div.className='added-item';
        const span=document.createElement('span');
        span.textContent=item;
        const removeBtn=document.createElement('button');
        removeBtn.textContent='Remove';
        removeBtn.className='remove-btn';
        removeBtn.onclick=()=>handleRemove(item);
        div.appendChild(span);
        div.appendChild(removeBtn);
        addedBox.appendChild(div);
    }
}

filterInput.addEventListener('keydown',e=>{if(e.key==='Enter')renderTables(filterInput.value)});
renderTables();

document.getElementById("goToGathering").addEventListener("click",async()=>{
    const selected=Array.from(addedItems);
    if(selected.length===0){
        alert("Please add at least one craft before proceeding.");
        return;
    }
    try{
        const res=await fetch("/submit_items",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({selected_items: selected})
        });
        if(res.ok){
            const data=await res.json();
            if(data.redirect){
                window.location.href=data.redirect;
            }else{
                alert("No redirect URL received from server.");
            }
        }else{
            alert("Error saving data. Server returned: "+res.status);
        }
    }catch(err){
        console.error("Error:",err);
        alert("Failed to connect to server.");
    }
});
</script>

<!-- Footer -->
<footer>
  <div style="flex:1;text-align:left;">version 0.2.0</div>
  <div style="flex:1;text-align:center;">built by Azure</div>
  <div style="flex:1;text-align:right;">
    <a href="https://github.com/NMiraglia05/Pull_Automator" target="_blank">source code</a>
  </div>
</footer>
</body>
</html>
