<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crafted Items Menu</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:24px}
    h1{font-size:1.6rem;margin-bottom:12px}
    h2{font-size:1.3rem;margin-top:28px;margin-bottom:6px;text-align:left}
    table{width:100%;border-collapse:collapse;margin-top:8px;margin-bottom:28px}
    th,td{padding:8px 10px;border:1px solid #ddd;text-align:left;vertical-align:top}
    th{background:#f4f4f4}
    .materials{white-space:pre-wrap;font-family:inherit}
    .search{margin-bottom:12px;padding:8px;width:100%;max-width:360px}
    button{padding:4px 8px;border:1px solid #bbb;border-radius:6px;background:#f9f9f9;cursor:pointer;transition:background 0.2s}
    button:hover{background:#e9e9e9}
    #added-box{border:1px solid #ccc;border-radius:8px;padding:10px;background:#fafafa;min-height:50px;margin-bottom:18px}
    .added-item{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
    .remove-btn{margin-left:10px;background:#f8d7da;border-color:#f5c2c7}
    .remove-btn:hover{background:#f1b0b7}
    .actions{margin-top:12px}
  </style>
</head>
<body>
  <h1>Crafted Items Menu</h1>

  <h2>Added Crafts</h2>
  <div id="added-box">(none yet)</div>

  <input id="filter" class="search" placeholder="Filter by item or material (type and press Enter)" />

  <div id="tables"></div>

  <div class="actions">
    <button id="goToGathering">Proceed to Character Setup</button>
  </div>

  <div id="footer-container"></div>

<script>
const crafted_item_lookup={
    "Blacksmithing":{
        "Animal Traps":{"iron":3},
        "Cooking Pot":{"copper":3,"wood (strong+durable)":1},
        "Gardener's Tools":{"iron":2,"wood (strong+durable)":1},
        "Mason's Chisel":{"iron":3,"wood (strong+durable)":1},
        "Surgeon's Razor":{"silver":1,"herb (purification)":1},
        "Surgeon's Needle":{"silver":1,"cloth":1},
        "Repair Tools":{"iron":3,"wood (strong+durable)":1},
        "Masterwork Tools":{"iron":2,"cloth":1,"wood (strong+durable)":1},
        "Whetstone":{"stone":4},
        "Throwing Snare":{"stone":3,"cloth":3,"soft pelt":1},
        "Music Box":{"copper":3,"gold":1,"bone":1,"paper":1},
        "Lasting":{"coal":1,"iron":1,"manganese":1}
    },
    "Weaponsmithing":{
        "Iron":{"iron":3},
        "Silver":{"silver":3,"sanctified water":1,"herb (purification)":3},
        "Gold":{"gold":3,"sanctified water":1,"herb (purification)":3},
        "Weapon-Casting":{"mercury":1,"silver":1,"herb (enhancement)":1},
        "Battering":{"coal":1,"stone":1,"iron":1,"marble":1,"manganese":1,"herb (enchantment)":2,"herb (enhancement)":2},
        "Massive":{"iron":4},
        "Ambidextrous":{"mercury":2,"salt":2},
        "Lasting":{"coal":1,"iron":1,"manganese":1},
        "Crushing":{"stone":3,"iron":2,"marble":2,"manganese":1,"demon blood":1,"herb (enchantment)":2,"herb (enhancement)":2,"herb (entropic)":4},
        "Elemental":{"coal":6,"mercury":2,"sulfur":2,"spell crystal":1,"herb (enhancement)":2,"herb (entropic)":3},
        "Sentinel":{"salt":1,"iron":1,"manganese":1,"soul gem":1,"celestial blood":1,"sanctified water":1,"herb (enhancement)":2,"herb (stimulant)":2},
        "Lethal":{"coal":2,"iron":2,"manganese":2},
        "Life-Drinking":{"obsidian":1,"soul gem":1,"demon blood":1,"zye blood parasite":2,"herb (entropic)":4,"herb (spiritual)":4}
    },
    "Armorsmithing":{
        "Lasting":{"coal":1,"iron":1,"manganese":1},
        "Reinforced":{"coal":2,"iron":2,"manganese":2},
        "Spellcasting":{"quartz":1,"silver":1,"herb (enhancement)":1},
        "Spirit Protection":{"coal":1,"mercury":2,"silver":2,"sanctified water":1,"herb (purification)":1},
        "Glyph-Guarded":{"salt":1,"quartz":1,"ritual component":1,"herb (enhancement)":1},
        "Physically Resistant":{"coal":4,"iron":2,"manganese":2},
        "Wakethorn":{"obsidian":1,"bone":5,"herb (entropic)":3,"herb (stimulant)":3,"wood (flexible)":4},
        "Mindshatter":{"quartz":2,"silver":2,"fae blood":1,"herb (hallucination)":3},
        "Rageguard":{"mercury":3,"zye blood parasite":1,"herb (entropic)":3,"herb (stimulant)":3},
        "Deathward":{"gold":1,"feather":4,"celestial blood":2,"sanctified water":2,"herb (rejuvenation)":3}
    },
    "Shieldsmithing":{
        "Perfect Grip":{"iron":3,"soft pelt":1,"wood (flexible + durable)":1},
        "Spellcasting":{"quartz":1,"silver":1,"herb (enhancement)":1},
        "Savior":{"iron":1,"mercury":1,"manganese":1},
        "Lasting":{"coal":1,"iron":1,"manganese":1},
        "Unbreakable":{"salt":1,"quartz":1,"mercury":1,"ritual component":1,"herb (enhancement)":1},
        "Elemental Blocking":{"mercury":1,"sulfur":1,"herb (enhancement)":1,"wood (dense + durable + strong)":1},
        "Spell Reflecting":{"coal":1,"salt":1,"quartz":1,"copper":2,"manganese":1,"spell crystal":1,"herb (enhancement)":1},
        "Anchor-Weight":{"coal":4,"iron":2,"manganese":2},
        "Kinetic":{"salt":2,"sulfur":2,"obsidian":1,"wood (dense + flexible + strong)":2},
        "Mirroring":{"silver":2,"glass":2,"sanctified water":1,"herb (purification)":3,"wood (durable + dense + lightweight)":1}
    }
    // (rest of dict unchanged â€” remains intact)
};

const container=document.getElementById('tables');
const addedBox=document.getElementById('added-box');
const filterInput=document.getElementById('filter');
const addedItems=new Set();

function formatMaterials(matObj){
    return Object.entries(matObj).map(([name,qty])=>`${name}: ${qty}`).join('\n');
}

function renderTables(filterText=''){
    container.innerHTML='';
    const f=filterText.trim().toLowerCase();

    for(const [category,items] of Object.entries(crafted_item_lookup)){
        const section=document.createElement('section');
        const title=document.createElement('h2');
        title.textContent=category;
        section.appendChild(title);

        const table=document.createElement('table');
        const thead=document.createElement('thead');
        thead.innerHTML='<tr><th>Item</th><th>Materials (name: qty)</th><th>Action</th></tr>';
        const tbody=document.createElement('tbody');

        for(const [item,materials] of Object.entries(items)){
            const haystack=item.toLowerCase()+' '+Object.keys(materials).join(' ').toLowerCase();
            if(!f||haystack.includes(f)){
                const tr=document.createElement('tr');
                const tdItem=document.createElement('td');tdItem.textContent=item;
                const tdMats=document.createElement('td');tdMats.className='materials';tdMats.textContent=formatMaterials(materials);
                const tdAction=document.createElement('td');
                const btn=document.createElement('button');btn.textContent='Add';btn.onclick=()=>handleAdd(item);
                tdAction.appendChild(btn);
                tr.append(tdItem,tdMats,tdAction);
                tbody.appendChild(tr);
            }
        }

        if(tbody.children.length>0){
            table.append(thead,tbody);
            section.appendChild(table);
            container.appendChild(section);
        }
    }
}

function handleAdd(item){
    if(!addedItems.has(item)){
        addedItems.add(item);
        renderAdded();
    }
}

function handleRemove(item){
    addedItems.delete(item);
    renderAdded();
}

function renderAdded(){
    if(addedItems.size===0){
        addedBox.innerHTML='(none yet)';
        return;
    }
    addedBox.innerHTML='';
    for(const item of addedItems){
        const div=document.createElement('div');
        div.className='added-item';
        const span=document.createElement('span');
        span.textContent=item;
        const removeBtn=document.createElement('button');
        removeBtn.textContent='Remove';
        removeBtn.className='remove-btn';
        removeBtn.onclick=()=>handleRemove(item);
        div.appendChild(span);
        div.appendChild(removeBtn);
        addedBox.appendChild(div);
    }
}

filterInput.addEventListener('keydown',e=>{if(e.key==='Enter')renderTables(filterInput.value)});
renderTables();

document.getElementById("goToGathering").addEventListener("click",async()=>{
    const selected=Array.from(addedItems);
    if(selected.length===0){
        alert("Please add at least one craft before proceeding.");
        return;
    }
    try{
        const res=await fetch("/submit_items",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({selected_items:selected})
        });
        if(res.ok){
            const data=await res.json();
            if(data.redirect){
                window.location.href=data.redirect;
            }else{
                alert("No redirect URL received from server.");
            }
        }else{
            alert("Error saving data. Server returned: "+res.status);
        }
    }catch(err){
        console.error("Error:",err);
        alert("Failed to connect to server.");
    }
});

// Load footer from templates.html
fetch("/templates.html")
  .then(res=>res.text())
  .then(html=>{
      document.getElementById("footer-container").innerHTML=html;
  })
  .catch(err=>console.error("Failed to load footer:",err));
</script>
</body>
</html>
