<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crafted Items Menu</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:24px}
  h1{font-size:1.6rem;margin-bottom:12px}
  h2.section-title{font-size:1.3rem;margin-top:28px;margin-bottom:6px;text-align:left}
  table{width:100%;border-collapse:collapse;margin-top:8px;margin-bottom:28px}
  th,td{padding:8px 10px;border:1px solid #ddd;text-align:left;vertical-align:top}
  th{background:#f4f4f4}
  .materials{white-space:pre-wrap;font-family:inherit}
  .search{margin-bottom:12px;padding:8px;width:100%;max-width:360px}
  button{padding:4px 8px;border:1px solid #bbb;border-radius:6px;background:#f9f9f9;cursor:pointer;transition:background 0.2s}
  button:hover{background:#e9e9e9}
  #added-box{border:1px solid #ccc;border-radius:8px;padding:10px;background:#fafafa;min-height:50px;margin-bottom:18px}
  .added-item{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
  .added-item .name{flex:1}
  .remove-btn{margin-left:10px;background:#ffdfe0;border:1px solid #f8a7a9}
  .remove-btn:hover{background:#ffcfd1}
  .actions{margin-top:12px}
  .debug{margin-top:10px;font-size:0.9rem;color:#7a7a7a}
</style>
</head>
<body>
  <h1>Crafted Items Menu</h1>

  <h2>Added Crafts</h2>
  <div id="added-box">(none yet)</div>

  <input id="filter" class="search" placeholder="Filter by item or material (type and press Enter)" />

  <div id="tables"></div>

  <div class="actions">
    <button id="goToGathering">Proceed to Character Setup</button>
  </div>

  <div class="debug" id="debug"></div>

<script>
/* ---------- data ---------- */
/* (replace/extend this object with your full dictionary if needed) */
const crafted_item_lookup = {
  "Blacksmithing": {
    "Animal Traps": {"iron":3},
    "Cooking Pot": {"copper":3,"wood (strong+durable)":1},
    "Gardener's Tools": {"iron":2,"wood (strong+durable)":1},
    "Mason's Chisel": {"iron":3,"wood (strong+durable)":1},
    "Surgeon's Razor": {"silver":1,"herb (purification)":1},
    "Surgeon's Needle": {"silver":1,"cloth":1},
    "Repair Tools": {"iron":3,"wood (strong+durable)":1},
    "Masterwork Tools": {"iron":2,"cloth":1,"wood (strong+durable)":1},
    "Whetstone": {"stone":4},
    "Throwing Snare": {"stone":3,"cloth":3,"soft pelt":1},
    "Music Box": {"copper":3,"gold":1,"bone":1,"paper":1},
    "Lasting": {"coal":1,"iron":1,"manganese":1}
  },
  "Weaponsmithing": {
    "Iron": {"iron":3},
    "Silver": {"silver":3,"sanctified water":1,"herb (purification)":3},
    "Gold": {"gold":3,"sanctified water":1,"herb (purification)":3},
    "Weapon-Casting": {"mercury":1,"silver":1,"herb (enhancement)":1},
    "Battering": {"coal":1,"stone":1,"iron":1,"marble":1,"manganese":1,"herb (enchantment)":2,"herb (enhancement)":2},
    "Massive": {"iron":4},
    "Ambidextrous": {"mercury":2,"salt":2},
    "Lasting": {"coal":1,"iron":1,"manganese":1},
    "Crushing": {"stone":3,"iron":2,"marble":2,"manganese":1,"demon blood":1,"herb (enchantment)":2,"herb (enhancement)":2,"herb (entropic)":4},
    "Elemental": {"coal":6,"mercury":2,"sulfur":2,"spell crystal":1,"herb (enhancement)":2,"herb (entropic)":3},
    "Sentinel": {"salt":1,"iron":1,"manganese":1,"soul gem":1,"celestial blood":1,"sanctified water":1,"herb (enhancement)":2,"herb (stimulant)":2},
    "Lethal": {"coal":2,"iron":2,"manganese":2},
    "Life-Drinking": {"obsidian":1,"soul gem":1,"demon blood":1,"zye blood parasite":2,"herb (entropic)":4,"herb (spiritual)":4}
  }
  // add rest of your big dictionary here...
};

/* ---------- ui refs & state ---------- */
const container = document.getElementById('tables');
const addedBox = document.getElementById('added-box');
const filterInput = document.getElementById('filter');
const debugEl = document.getElementById('debug');

let addedItems = []; // maintain as array for deterministic ordering and JSON

/* ---------- helpers ---------- */
function logDebug(msg){
  console.log(msg);
  debugEl.textContent = String(msg);
}
function formatMaterials(matObj){
  if(!matObj || typeof matObj !== 'object') return '—';
  return Object.entries(matObj).map(([name,qty]) => `${name}: ${qty}`).join('\n');
}

/* build the tables by category, each category is its own table with left-aligned header */
function renderTables(filterText=''){
  container.innerHTML = '';
  const f = filterText.trim().toLowerCase();

  for(const [category, items] of Object.entries(crafted_item_lookup)){
    // create a section with header (left aligned)
    const section = document.createElement('section');
    const title = document.createElement('h2');
    title.className = 'section-title';
    title.style.textAlign = 'left';
    title.textContent = category;
    section.appendChild(title);

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th style="text-align:left">Item</th><th style="text-align:left">Materials (name: qty)</th><th style="text-align:left">Action</th></tr>';
    const tbody = document.createElement('tbody');

    for(const [item, materials] of Object.entries(items)){
      const haystack = (item + ' ' + Object.keys(materials).join(' ')).toLowerCase();
      if(!f || haystack.includes(f)){
        const tr = document.createElement('tr');

        const tdItem = document.createElement('td');
        tdItem.textContent = item;

        const tdMats = document.createElement('td');
        tdMats.className = 'materials';
        tdMats.textContent = formatMaterials(materials);

        const tdAction = document.createElement('td');
        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add';
        addBtn.addEventListener('click', () => handleAdd(item));
        tdAction.appendChild(addBtn);

        tr.append(tdItem, tdMats, tdAction);
        tbody.appendChild(tr);
      }
    }

    if(tbody.children.length > 0){
      table.append(thead, tbody);
      section.appendChild(table);
      container.appendChild(section);
    }
  }
}

/* ---------- add/remove items ---------- */
function handleAdd(item){
  if(!addedItems.includes(item)){
    addedItems.push(item);
    renderAdded();
  } else {
    // optional: flash or notify already added
    logDebug(`"${item}" already in list.`);
  }
}
function handleRemove(item){
  const idx = addedItems.indexOf(item);
  if(idx !== -1){
    addedItems.splice(idx,1);
    renderAdded();
  }
}

function renderAdded(){
  addedBox.innerHTML = '';
  if(addedItems.length === 0){
    addedBox.textContent = '(none yet)';
    return;
  }
  addedItems.forEach(item => {
    const div = document.createElement('div');
    div.className = 'added-item';

    const span = document.createElement('span');
    span.className = 'name';
    span.textContent = item;

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = 'Remove';
    removeBtn.addEventListener('click', () => handleRemove(item));

    div.append(span, removeBtn);
    addedBox.appendChild(div);
  });
}

/* ---------- submission with robust error handling and fallback endpoints ---------- */
async function postSelected(selected){
  // try primary endpoint then fallback
  const endpoints = ['/api/set_items','/submit_items','/api/submit_items'];
  for(const ep of endpoints){
    try{
      logDebug(`Attempting POST to ${ep} ...`);
      const res = await fetch(ep, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({selected})
      });
      const statusText = `${res.status} ${res.statusText}`;
      let bodyText = '';
      // attempt to parse JSON, otherwise text
      try { bodyText = await res.text(); } catch(e){ bodyText = '<unreadable body>'; }
      if(res.ok){
        // if server returns JSON with redirect, follow it; otherwise just show success
        try{
          const parsed = JSON.parse(bodyText || '{}');
          if(parsed.redirect){
            logDebug(`Saved successfully; redirecting to ${parsed.redirect}`);
            window.location.href = parsed.redirect;
            return;
          }
        }catch(e){
          // not JSON — proceed
        }
        alert(`Saved successfully to ${ep}. Server response: ${statusText}`);
        return;
      } else {
        // not OK - continue to next endpoint but show helpful info
        logDebug(`Endpoint ${ep} returned ${statusText}. Response body:\n${bodyText}`);
      }
    }catch(err){
      logDebug(`Network/Fetch error posting to ${ep}: ${err}`);
    }
  }
  // if we get here, all endpoints failed
  alert('Failed to save to server. See console or debug area for details.');
}

/* ---------- wire up UI ---------- */
document.getElementById('goToGathering').addEventListener('click', async () => {
  if(addedItems.length === 0){
    alert('Please add at least one craft before proceeding.');
    return;
  }
  // disable button while posting
  const btn = document.getElementById('goToGathering');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  await postSelected(addedItems);
  btn.disabled = false;
  btn.textContent = 'Proceed to Character Setup';
});

/* filter handling */
filterInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){
    e.preventDefault();
    renderTables(filterInput.value);
  }
});

/* initial render */
renderTables();
renderAdded();
</script>
</body>
</html>
