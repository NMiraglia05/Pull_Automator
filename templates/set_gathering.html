{% extends "template.html" %}
{% block title %}Character Row{% endblock %}

{% block content %}
<h1>Character Row Setup</h1>
<p class="note">Fill in your characterâ€™s stats and cargo ship count, then submit.</p>

<h2>Selected Items</h2>
<div id="selected-box">(none)</div>

<form id="rowsForm">
  <div class="rows" id="rowsContainer">
    <div class="row">
      <div>
        <label>Character name</label>
        <input type="text" name="character_name" required minlength="1" placeholder="Enter name" />
      </div>
      <div><label>Mercantile</label><select name="mercantile"></select></div>
      <div><label>Black Market</label><select name="black_market"></select></div>
      <div><label>Hunting</label><select name="hunting"></select></div>
      <div><label>Mining</label><select name="mining"></select></div>
      <div><label>Cargo ship</label><select name="cargo_ship"></select></div>
    </div>
  </div>
  <div class="actions">
    <button type="submit">Submit</button>
  </div>
</form>

<script>
const rowsContainer=document.getElementById('rowsContainer');
const form=document.getElementById('rowsForm');
const selectedBox=document.getElementById('selected-box');

// Load selected items from Flask
const selectedItems={{ selected_items|tojson }};
if(selectedItems.length>0){
  selectedBox.innerHTML='';
  selectedItems.forEach(item=>{
    const div=document.createElement('div');
    div.textContent=item;
    selectedBox.appendChild(div);
  });
}

// Populate select dropdowns
function buildOptions(selectEl,start,end,defaultVal=0){
  selectEl.innerHTML='';
  for(let i=start;i<=end;i++){
    const opt=document.createElement('option'); 
    opt.value=i; 
    opt.textContent=i;
    if(i===defaultVal) opt.selected=true;
    selectEl.appendChild(opt);
  }
}

const row=rowsContainer.querySelector('.row');
const merc=row.querySelector('select[name="mercantile"]');
const bm=row.querySelector('select[name="black_market"]');
const hunting=row.querySelector('select[name="hunting"]');
const mining=row.querySelector('select[name="mining"]');
const cargo=row.querySelector('select[name="cargo_ship"]');

[merc,bm,hunting,mining].forEach(s=>buildOptions(s,0,4,0));
buildOptions(cargo,0,10,0);

// Submit handler sends data to Flask
form.addEventListener('submit',async e=>{
  e.preventDefault();

  const inp=row.querySelector('input[name="character_name"]');
  if(!inp.value.trim()){ 
    alert('Please fill in the character name before submitting.'); 
    inp.focus(); 
    return; 
  }

  const character_data={
    character_name:inp.value.trim(),
    gathering_skills:{
      mercantile:Number(merc.value),
      black_market:Number(bm.value),
      hunting:Number(hunting.value),
      mining:Number(mining.value),
      cargo_ship:Number(cargo.value)
    }
  };

  const payload={
    selected_items:selectedItems,
    character_data:character_data
  };

  const response=await fetch("/submit_gathering",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const html=await response.text();
  document.open();
  document.write(html);
  document.close();
});
</script>
{% endblock %}
